# Архитектура проекта

## Общая структура

Проект построен на основе Django с использованием REST API для взаимодействия с фронтендом. Архитектура включает следующие компоненты:

1. **Django + DRF**: Основной бэкенд, обрабатывающий HTTP-запросы
2. **PostgreSQL**: Реляционная база данных для хранения данных
3. **Redis**: Брокер сообщений для Celery и кэширование
4. **Celery**: Обработка асинхронных задач (отправка email, импорт товаров)
5. **Nginx**: Веб-сервер для обслуживания статических файлов и проксирования запросов
6. **Gunicorn**: WSGI-сервер для запуска Django-приложения

## Диаграмма компонентов

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│             │     │             │     │             │
│   Клиент    │────▶│    Nginx    │────▶│   Gunicorn  │
│             │     │             │     │             │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                                               ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│             │     │             │     │             │
│   Celery    │◀───▶│    Redis    │◀───▶│    Django   │
│             │     │             │     │             │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │             │
                                        │ PostgreSQL  │
                                        │             │
                                        └─────────────┘
```

## Структура приложения Django

```
myproject/
├── myproject/          # Основной проект Django
│   ├── __init__.py
│   ├── celery.py       # Конфигурация Celery
│   ├── settings.py     # Настройки проекта
│   ├── urls.py         # URL-маршруты
│   ├── wsgi.py         # WSGI-конфигурация
│   └── asgi.py         # ASGI-конфигурация
├── shop/               # Приложение интернет-магазина
│   ├── __init__.py
│   ├── admin.py        # Настройки админ-панели
│   ├── admin_views.py  # Представления для админ-панели
│   ├── apps.py         # Конфигурация приложения
│   ├── models.py       # Модели данных
│   ├── serializers.py  # Сериализаторы для API
│   ├── tasks.py        # Задачи Celery
│   ├── urls.py         # URL-маршруты приложения
│   ├── utils.py        # Вспомогательные функции
│   ├── views.py        # Основные представления
│   ├── views_address.py # Представления для адресов доставки
│   ├── views_order.py  # Представления для заказов
│   ├── views_supplier.py # Представления для поставщиков
│   └── tests/          # Тесты
│       ├── __init__.py
│       ├── factories.py # Фабрики для тестов
│       ├── test_models.py # Тесты моделей
│       ├── test_api.py # Тесты API
│       ├── test_tasks.py # Тесты задач Celery
│       ├── test_utils.py # Тесты утилит
│       ├── test_views.py # Тесты представлений
│       └── test_serializers.py # Тесты сериализаторов
├── docs/               # Документация
├── nginx/              # Конфигурация Nginx
├── media/              # Медиа-файлы
├── staticfiles/        # Статические файлы
├── Dockerfile          # Инструкции для сборки контейнера Django
├── Dockerfile.celery   # Инструкции для сборки контейнера Celery
├── docker-compose.yml  # Конфигурация Docker Compose
├── requirements.txt    # Зависимости Python
└── README.md           # Описание проекта
```

## Модели данных

### Диаграмма моделей

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    User     │─────┤   Supplier  │─────┤   Product   │
└─────────────┘     └─────────────┘     └──────┬──────┘
      │                                        │
      │                                        │
┌─────┴───────┐     ┌─────────────┐     ┌──────┴──────┐
│DeliveryAddress    │    Order    │─────┤  OrderItem  │
└─────────────┘     └──────┬──────┘     └─────────────┘
                           │
                    ┌──────┴──────┐
                    │  CartItem   │
                    └─────────────┘
```

## Потоки данных

### Регистрация и аутентификация

1. Клиент отправляет запрос на регистрацию с данными пользователя
2. Сервер создает пользователя и профиль поставщика (если указан тип пользователя 'supplier')
3. Сервер генерирует токен аутентификации и отправляет его клиенту
4. Клиент использует токен для аутентификации в последующих запросах

### Оформление заказа

1. Клиент добавляет товары в корзину
2. Клиент отправляет запрос на оформление заказа с указанием адреса доставки
3. Сервер создает заказ и элементы заказа на основе содержимого корзины
4. Сервер уменьшает количество товаров на складе
5. Сервер очищает корзину пользователя
6. Сервер асинхронно отправляет email с подтверждением заказа пользователю
7. Сервер асинхронно отправляет уведомления поставщикам о новом заказе

### Импорт товаров

1. Поставщик отправляет запрос на импорт товаров с YAML данными
2. Сервер запускает асинхронную задачу импорта товаров
3. Задача импорта создает или обновляет товары на основе YAML данных
4. Сервер возвращает результат импорта (количество созданных и обновленных товаров)

## Безопасность

### Аутентификация

Проект использует несколько методов аутентификации:
- Token Authentication (DRF)
- JWT Authentication (Simple JWT)
- Session Authentication (для админ-панели)

### Авторизация

Доступ к API ограничен на основе типа пользователя:
- Анонимные пользователи могут просматривать товары
- Аутентифицированные пользователи могут управлять корзиной и заказами
- Поставщики могут управлять своими товарами
- Администраторы имеют полный доступ ко всем ресурсам

### Защита от CSRF

Django автоматически включает защиту от CSRF для всех POST, PUT, PATCH и DELETE запросов.

### Ограничение частоты запросов

Проект использует ограничение частоты запросов для защиты от DoS-атак:
- Анонимные пользователи: 100 запросов в день
- Аутентифицированные пользователи: 1000 запросов в день

## Масштабирование

### Горизонтальное масштабирование

Проект может быть горизонтально масштабирован путем добавления дополнительных экземпляров контейнеров:
- Несколько экземпляров Django/Gunicorn за балансировщиком нагрузки
- Несколько воркеров Celery для обработки асинхронных задач
- Репликация PostgreSQL для распределения нагрузки на чтение

### Кэширование

Для улучшения производительности можно использовать:
- Redis для кэширования запросов
- CDN для статических файлов
- Кэширование на уровне Nginx